<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>ELF文件 - Living@Greatwall</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/elfwen-jian.html">

        <meta name="author" content="jin" />
        <meta name="keywords" content="os,bootloader,elf,header,linker" />
        <meta name="description" content="ELF(Executable and linking format)文件格式是Linux系统下的一种常用目标文件(object file)格式，有三种主要类型: 用于执行的可执行文件(executab file)，用于提供程序的进程映像，加载的内存执行。 这也是本实验的OS文件类型。 用于连接的可重定位文件(relocatable file)，可与其它目标文件一起创建可执行文件和共享目标文件。 共享目标文件(shared object file),连接器可将它与其它可重定位文件和共享目标文件连接成其它的目标文件， 动态连接器又可将它与可执行文件和其它共享目标文件结合起来创建一个进程映像。 ELF文件是由一个ELF header和紧接着的几个program header（长度不等），这些program header指明了每个段的大小和内容，如： *.text *.rodata *.data 这里只分析与本实验相关的ELF可执行文件类型。ELF header在文件开始处描述了整个文件的组织。ELF的文件头包含整个执行文件的 控制结构，其定义在elf.h中： struct elfhdr { uint magic; // must equal ELF_MAGIC ..." />

        <meta property="og:site_name" content="Living@Greatwall" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="ELF文件"/>
        <meta property="og:url" content="/elfwen-jian.html"/>
        <meta property="og:description" content="ELF(Executable and linking format)文件格式是Linux系统下的一种常用目标文件(object file)格式，有三种主要类型: 用于执行的可执行文件(executab file)，用于提供程序的进程映像，加载的内存执行。 这也是本实验的OS文件类型。 用于连接的可重定位文件(relocatable file)，可与其它目标文件一起创建可执行文件和共享目标文件。 共享目标文件(shared object file),连接器可将它与其它可重定位文件和共享目标文件连接成其它的目标文件， 动态连接器又可将它与可执行文件和其它共享目标文件结合起来创建一个进程映像。 ELF文件是由一个ELF header和紧接着的几个program header（长度不等），这些program header指明了每个段的大小和内容，如： *.text *.rodata *.data 这里只分析与本实验相关的ELF可执行文件类型。ELF header在文件开始处描述了整个文件的组织。ELF的文件头包含整个执行文件的 控制结构，其定义在elf.h中： struct elfhdr { uint magic; // must equal ELF_MAGIC ..."/>
        <meta property="article:published_time" content="2013-01-15" />
            <meta property="article:section" content="os" />
            <meta property="article:tag" content="os" />
            <meta property="article:tag" content="bootloader" />
            <meta property="article:tag" content="elf" />
            <meta property="article:tag" content="header" />
            <meta property="article:tag" content="linker" />
            <meta property="article:author" content="jin" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Living@Greatwall            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="/category/cc.html">C&c++</a>
                        </li>
                        <li >
                            <a href="/category/linux.html">Linux</a>
                        </li>
                        <li class="active">
                            <a href="/category/os.html">Os</a>
                        </li>
                        <li >
                            <a href="/category/python.html">Python</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/elfwen-jian.html"
                       rel="bookmark"
                       title="Permalink to ELF文件">
                        ELF文件
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-01-15T00:00:00+08:00"> Tue 15 January 2013</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="/tag/os.html">os</a>
        /
	<a href="/tag/bootloader.html">bootloader</a>
        /
	<a href="/tag/elf.html">elf</a>
        /
	<a href="/tag/header.html">header</a>
        /
	<a href="/tag/linker.html">linker</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>ELF(Executable  and linking format)文件格式是Linux系统下的一种常用目标文件(object    file)格式，有三种主要类型:</p>
<ul>
<li>
<p>用于执行的可执行文件(executab   file)，用于提供程序的进程映像，加载的内存执行。  这也是本实验的OS文件类型。</p>
</li>
<li>
<p>用于连接的可重定位文件(relocatable file)，可与其它目标文件一起创建可执行文件和共享目标文件。</p>
</li>
<li>
<p>共享目标文件(shared object  file),连接器可将它与其它可重定位文件和共享目标文件连接成其它的目标文件，
动态连接器又可将它与可执行文件和其它共享目标文件结合起来创建一个进程映像。</p>
</li>
</ul>
<p>ELF文件是由一个ELF header和紧接着的几个program header（长度不等），这些program header指明了每个段的大小和内容，如：</p>
<p>*.text</p>
<p>*.rodata</p>
<p>*.data</p>
<p>这里只分析与本实验相关的ELF可执行文件类型。ELF  header在文件开始处描述了整个文件的组织。ELF的文件头包含整个执行文件的
控制结构，其定义在elf.h中：</p>
<div class="highlight"><pre><span class="k">struct</span>  <span class="n">elfhdr</span>  <span class="p">{</span>
  <span class="n">uint</span>  <span class="n">magic</span><span class="p">;</span>   <span class="c1">// must    equal   ELF_MAGIC</span>
  <span class="n">uchar</span> <span class="n">elf</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
  <span class="n">ushort</span>    <span class="n">type</span><span class="p">;</span>
  <span class="n">ushort</span>    <span class="n">machine</span><span class="p">;</span>
  <span class="n">uint</span>  <span class="n">version</span><span class="p">;</span>
  <span class="n">uint</span>  <span class="n">entry</span><span class="p">;</span>   <span class="c1">// 程序入口的虚拟地址</span>
  <span class="n">uint</span>  <span class="n">phoff</span><span class="p">;</span>   <span class="c1">// program header  表的位置偏移</span>
  <span class="n">uint</span>  <span class="n">shoff</span><span class="p">;</span>
  <span class="n">uint</span>  <span class="n">flags</span><span class="p">;</span>
  <span class="n">ushort</span>    <span class="n">ehsize</span><span class="p">;</span>
  <span class="n">ushort</span>    <span class="n">phentsize</span><span class="p">;</span>
  <span class="n">ushort</span>    <span class="n">phnum</span><span class="p">;</span>  <span class="c1">//program   header表中的入口数目</span>
  <span class="n">ushort</span>    <span class="n">shentsize</span><span class="p">;</span>
  <span class="n">ushort</span>    <span class="n">shnum</span><span class="p">;</span>
  <span class="n">ushort</span>    <span class="n">shstrndx</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>


<p>program header描述与程序执行直接相关的目标文件结构信息，用来在文件中定位各个段的映像，同时包含其他一些用来为
程序创建进程映像所必需的信息。可执行文件的程序头部是一个program header结构的数组，    每个结构描述了一个段或者系统准备程序执行i
所必需的其它信息。目标文件的  “段” 包含一个或者多个    “节区”（section）   ，也就是“段内容（Segment Contents）”。
程序头部仅对于可执行文件和共享目标文件有意义。可执行目标文件在ELF头部的e_phentsize和e_phnum成员中给出其自身程序头部的大小。
程序头部的数据结构如下表所示：</p>
<div class="highlight"><pre><span class="k">struct</span>  <span class="n">proghdr</span> <span class="p">{</span>
  <span class="n">uint</span>  <span class="n">type</span><span class="p">;</span>    <span class="c1">// 段类型</span>
  <span class="n">uint</span>  <span class="n">offset</span><span class="p">;</span>  <span class="c1">// 段相对文件头的偏移值</span>
  <span class="n">uint</span>  <span class="n">va</span><span class="p">;</span>  <span class="c1">// 段的第一个字节将被放到内存中的虚拟地址</span>
  <span class="n">uint</span>  <span class="n">pa</span><span class="p">;</span>
  <span class="n">uint</span>  <span class="n">filesz</span><span class="p">;</span>
  <span class="n">uint</span>  <span class="n">memsz</span><span class="p">;</span>   <span class="c1">// 段在内存映像中占用的字节数</span>
  <span class="n">uint</span>  <span class="n">flags</span><span class="p">;</span>
  <span class="n">uint</span>  <span class="n">align</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>


<p>根据elfhdr和proghdr的结构描述，bootloader就可以完成对ELF格式的ucore操作系统的加载过程（参见boot/bootmain.c中的bootmain函数）。</p>
<h3>[补充材料]</h3>
<p>Link    addr&amp;Load   addr</p>
<ul>
<li>Link Address是指编译器指定代码和数据所需要放置的内存地址，由链接器配置。</li>
<li>Load  Address是指程序被实际加载到内存的位置（由程序加载器ld配置）。一般由可执行文件结构信息和加载器可保证这两个地址相同。Link  </li>
</ul>
<p>Addr和LoadAddr不同会导致：直接跳转位置错误直接内存访问(只读数据区或bss等直接地址访问)错误堆和栈等的使用不受影响，
但是可能会覆盖程序、数据区域  注意：也存在Link地址和Load地址不一样的情况（例如：动态链接库）。</p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://lxr.free-electrons.com" target="_blank">
                Online Linux Kernel Source Code
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://coolshell.cn" target="_blank">
                酷壳CoolShell
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 Jin
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>


</body>
</html>